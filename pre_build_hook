#!/bin/bash

set -eux

BUILD_FOR=${BUILD_FOR:-ubuntu}
DIR="$(dirname `readlink -f $0`)"

function build_pkg {
  case $1 in
    ubuntu)
      cd ${DIR}/qemu
      sudo docker build -t qemu .
      container_id=`sudo docker run -d qemu`
      sudo docker cp $container_id:/qemu-block-extra_2.4+dfsg-4ubuntu1_amd64.deb ${DIR}/repositories/ubuntu/
      sudo docker cp $container_id:/qemu-system_2.4+dfsg-4ubuntu1_amd64.deb ${DIR}/repositories/ubuntu/
      sudo docker cp $container_id:/qemu-utils_2.4+dfsg-4ubuntu1_amd64.deb ${DIR}/repositories/ubuntu/
      sudo docker cp $container_id:/qemu_2.4+dfsg-4ubuntu1_amd64.deb ${DIR}/repositories/ubuntu/
      sudo docker cp $container_id:/qemu-user_2.4+dfsg-4ubuntu1_amd64.deb ${DIR}/repositories/ubuntu/
    ;;
    *) echo "Not supported system"; exit 1;;
  esac
}

for system in $BUILD_FOR
do
  build_pkg $system
done
